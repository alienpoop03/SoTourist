<ion-content class="itinerario-content" fullscreen>

  <!-- â”€â”€â”€â”€â”€ HERO â”€â”€â”€â”€â”€ -->
  <div #hero class="hero" [ngStyle]="{ 'background-image': heroPhotoUrl ? 'url(' + heroPhotoUrl + ')' : 'none',
                    'height.px': heroHeight }">
    <div class="overlay" [ngStyle]="{ 'opacity': overlayOpacity }">
      <h1 [ngStyle]="{ 'font-size': titleFontSize + 'rem' }">Benvenuto a: {{ trip?.city }}</h1>

      <div class="hero-info">
        <div class="hero-left" *ngIf="trip?.startDate && trip?.endDate" (click)="openDateEdit()">
          <p class="dates">
            Dal {{ trip.startDate | date:'dd/MM' }} al {{ trip.endDate | date:'dd/MM' }}
          </p>
        </div>
        <div class="hero-right" *ngIf="trip?.accommodation" (click)="openAccommodationEdit()">
          <p class="accommodation">{{ trip.accommodation }}</p>
        </div>
      </div>

    </div>
  </div>

  <!-- â”€â”€â”€â”€â”€ PAGINATION DOTS â”€â”€â”€â”€â”€ -->
  <div class="slide-indicator">
    <span *ngFor="let name of slideNames; let i = index" [class.active]="i === currentSlide" (click)="goToSlide(i)">{{
      name }}</span>
  </div>

  <!-- spacer -->
  <!-- <div class="slide-page"></div> -->

  <div #scrollContainer class="scroll-container" (scroll)="onScroll($event)">

    <!-- â–¸ SLIDE 0 â€“ LUOGHI -->
    <div class="slide-page places no-vert-scroll">
      <h2 class="slide-title">Selezione Luoghi</h2>

      <!-- mustSee -->
      <ion-item button (click)="openEditorInline('mustSee')">
        <ion-label>Luoghi da non perdere</ion-label>
        <div slot="end" class="item-preview">
          <ng-container *ngIf="tripMustSee?.length; else emptyMust">
            <span class="chip-preview" *ngFor="let p of tripMustSee.slice(0,2)">{{ p }}</span>
            <span *ngIf="tripMustSee.length > 2">+{{ tripMustSee.length - 2 }}</span>
          </ng-container>
          <ng-template #emptyMust>Nessun luogo inserito</ng-template>
        </div>
      </ion-item>

      <!-- eat -->
      <ion-item button (click)="openEditorInline('eat')">
        <ion-label>Posti dove vuoi mangiare</ion-label>
        <div slot="end" class="item-preview">
          <ng-container *ngIf="tripEatPlaces?.length; else emptyEat">
            <span class="chip-preview" *ngFor="let p of tripEatPlaces.slice(0,2)">{{ p }}</span>
            <span *ngIf="tripEatPlaces.length > 2">+{{ tripEatPlaces.length - 2 }}</span>
          </ng-container>
          <ng-template #emptyEat>Nessuno specificato</ng-template>
        </div>
      </ion-item>

      <!-- visited -->
      <ion-item button (click)="openEditorInline('visited')">
        <ion-label>Posti giÃ  visitati</ion-label>
        <div slot="end" class="item-preview">
          <ng-container *ngIf="tripAlreadyVisited?.length; else emptyVis">
            <span class="chip-preview" *ngFor="let p of tripAlreadyVisited.slice(0,2)">{{ p }}</span>
            <span *ngIf="tripAlreadyVisited.length > 2">+{{ tripAlreadyVisited.length - 2 }}</span>
          </ng-container>
          <ng-template #emptyVis>Nessuno</ng-template>
        </div>
      </ion-item>
    </div>

    <!-- â–¸ SLIDE 1 â€“ PREFERENZE -->
    <div class="slide-page prefs no-vert-scroll">
      <h2 class="slide-title">Personalizza il tuo viaggio</h2>

      <ion-item button (click)="openEditorInline('transport')">
        <ion-label>Mezzo preferito</ion-label>
        <div slot="end" class="item-preview">{{ tripTransport || 'Nessun mezzo selezionato' }}</div>
      </ion-item>

      <ion-item button (click)="openEditorInline('style')">
        <ion-label>Stile vacanza</ion-label>
        <div slot="end" class="item-preview">{{ trip?.style || 'Nessuno' }}</div>
      </ion-item>

      <ion-item button (click)="openEditorInline('ai')">
        <ion-label>Chiedi un consiglio all'AI</ion-label>
        <div slot="end" class="item-preview">{{ tripPrompt || 'Nessun consiglio' }}</div>
      </ion-item>
    </div>

    <!-- â–¸ SLIDE 2 â€“ GIORNI -->
    <div class="slide-page">
      <div class="day-list">
        <div *ngFor="let _ of [].constructor(daysCount); let i = index" class="timeline-entry">

          <ion-card (click)="openDay(i)" class="day-card">
            <ion-card-header>
              <ion-card-title>
                <div class="day-label">Giorno {{ i+1 }}</div>
                <ion-button fill="clear" size="small" class="style-ed-btn top-right-btn"
                  (click)="vaiAPersonalizzazione(); $event.stopPropagation()">
                  <ion-icon name="calendar-outline"></ion-icon>
                </ion-button>
              </ion-card-title>
            </ion-card-header>


            <ion-card-content>
              <p *ngIf="getDayItems(i).length; else placeholder">
                <ng-container *ngFor="let item of getDayItems(i); let last = last">
                  <strong>â€¢</strong> {{ item }}<span *ngIf="!last">&nbsp;&nbsp;</span>
                </ng-container>
              </p>
              <ng-template #placeholder>
                <p>Programma per il giorno {{ i+1 }}â€¦</p>
              </ng-template>
            </ion-card-content>
          </ion-card>

        </div>
        <div *ngIf="daysCount===0" class="no-days">Nessun giorno da mostrare.</div>
      </div>
    </div>
  </div><!-- /scroll-container -->

  <!-- â”€â”€â”€â”€â”€ MODALE (bottom-sheet) â”€â”€â”€â”€â”€ -->
  <div class="customization-sheet inline-editor" [class.visible]="editorVisible">
    <div class="sheet-header">
      <h2>{{ { mustSee:'Luoghi da non perdere', eat:'Posti dove mangiare', visited:'Luoghi giÃ  visti',
        transport:'Mezzo preferito', ai:'Domanda per l\u2019AI', style:'Stile vacanza'}[editorMode!] }}</h2>
      <ion-button fill="clear" size="small" (click)="closeEditor()">Chiudi</ion-button>
    </div>

    <div class="sheet-content">

      <!-- mustSee -->
      <ng-container *ngIf="editorMode === 'mustSee'">
        <app-google-autocomplete placeholder="Aggiungi un luogo da non perdereâ€¦" [types]="['establishment']"
          [bounds]="tripBounds" [restrictToBounds]="true" (placeSelected)="onPlaceSelected('mustSee', $event)">
        </app-google-autocomplete>


        <ion-button expand="block" (click)="saveEditorValue()">Salva</ion-button>

        <div class="chip-container">
          <div class="chip" *ngFor="let p of tripMustSee; let i = index">
            {{ p }}
            <button class="chip-remove" (click)="removePlaceFromMode('mustSee', i)">âœ•</button>
          </div>
        </div>
      </ng-container>

      <!-- eat -->
      <ng-container *ngIf="editorMode === 'eat'">
        <app-google-autocomplete placeholder="Aggiungi un posto dove mangiareâ€¦" [types]="['restaurant']"
          [bounds]="tripBounds" [restrictToBounds]="true" (placeSelected)="onPlaceSelected('eat', $event)">
        </app-google-autocomplete>


        <ion-button expand="block" (click)="saveEditorValue()">Salva</ion-button>

        <div class="chip-container">
          <div class="chip" *ngFor="let p of tripEatPlaces; let i = index">
            {{ p }}
            <button class="chip-remove" (click)="removePlaceFromMode('eat', i)">âœ•</button>
          </div>
        </div>
      </ng-container>

      <!-- visited -->
      <ng-container *ngIf="editorMode === 'visited'">
        <app-google-autocomplete placeholder="Aggiungi un luogo giÃ  visitatoâ€¦" [types]="['establishment']"
          [bounds]="tripBounds" [restrictToBounds]="true" (placeSelected)="onPlaceSelected('visited', $event)">
        </app-google-autocomplete>


        <ion-button expand="block" (click)="saveEditorValue()">Salva</ion-button>

        <div class="chip-container">
          <div class="chip" *ngFor="let p of tripAlreadyVisited; let i = index">
            {{ p }}
            <button class="chip-remove" (click)="removePlaceFromMode('visited', i)">âœ•</button>
          </div>
        </div>
      </ng-container>

      <!-- style -->
      <ng-container *ngIf="editorMode === 'style'">
        <ion-list>
          <ion-item button (click)="selectValue('Standard')">ğŸš¶â€â™‚ï¸ Standard</ion-item>
          <ion-item button (click)="selectValue('Giornata al mare')">ğŸš— Giornata al mare</ion-item>
          <ion-item button (click)="selectValue('Giornata nei musei')">ğŸšŒ Giornata nei musei</ion-item>
          <ion-item button (click)="selectValue('Shopping')">ğŸš´â€â™€ï¸ Shopping</ion-item>
          <ion-item button (click)="selectValue('Avventura')">ğŸš´â€â™€ï¸ Avventura</ion-item>
          <ion-item button (click)="selectValue('Food Tour')">ğŸš´â€â™€ï¸ Food Tour</ion-item>
          <ion-item button (click)="selectValue('Escursione')">ğŸš´â€â™€ï¸ Escursione</ion-item>
          <ion-item button (click)="selectValue('Relax')">ğŸš´â€â™€ï¸ Relax</ion-item>




        </ion-list>

      </ng-container>


      <!-- transport -->
      <ng-container *ngIf="editorMode === 'transport'">
        <ion-list>
          <ion-item button (click)="selectValue('walk')">ğŸš¶â€â™‚ï¸ A piedi</ion-item>
          <ion-item button (click)="selectValue('car')">ğŸš— Auto</ion-item>
          <ion-item button (click)="selectValue('bus')">ğŸšŒ Bus</ion-item>
          <ion-item button (click)="selectValue('bike')">ğŸš´â€â™€ï¸ Bicicletta</ion-item>
        </ion-list>
      </ng-container>

      <!-- ai -->
      <ng-container *ngIf="editorMode === 'ai'">
        <ion-textarea autoGrow="true" placeholder="Scrivi quiâ€¦" [(ngModel)]="editorValue"
          (ngModelChange)="setValueForMode('ai', $event)"></ion-textarea>
        <ion-button expand="block" (click)="saveEditorValue()">Salva</ion-button>
      </ng-container>
    </div>
  </div>

  <!-- â”€â”€â”€â”€â”€ FAB Genera Itinerario â”€â”€â”€â”€â”€ -->
  <div class="generate-container fixed">
    <ion-button class="genera-itinerario-btn" (click)="generateItinerary()" *ngIf="!isLoading && isLocalTrip">
      <!-- <ion-icon name="analytics-outline" slot="start"></ion-icon> -->
      Genera Itinerario
    </ion-button>
    <ion-button class="genera-itinerario-btn" disabled *ngIf="isLoading">
      <!-- <ion-icon name="hourglass-outline" slot="start"></ion-icon> -->
      Caricamentoâ€¦
    </ion-button>
    <ion-button class="genera-itinerario-btn" disabled *ngIf="!isLoading && !isLocalTrip">
      <!-- <ion-icon name="checkmark-done-outline" slot="start"></ion-icon> -->
      Itinerario giÃ  generato
    </ion-button>
  </div>

</ion-content>
<!-- Overlay -->
<app-generation-overlay *ngIf="isLoading" [message]="'Generazione in corsoâ€¦'"></app-generation-overlay>