<app-navigation-bar title="Itinerario" [backUrl]="'/tabs/viaggi'"></app-navigation-bar>

<ion-content class="itinerario-content" fullscreen>

  <!-- PAGINATION DOTS -->
  <div class="slide-indicator">
    <span *ngFor="let name of slideNames; let i = index" [class.active]="i === currentSlide" (click)="goToSlide(i)">
      {{ name }}
    </span>
  </div>

  <div #scrollContainer class="scroll-container" (scroll)="onScroll($event)">

    <!-- SLIDE 0 – SELEZIONE LUOGHI -->
    <div class="slide-page places no-vert-scroll">
      <h2 class="slide-title">Selezione Luoghi</h2>

      <!-- mustSee -->
      <ion-item button (click)="openEditorInline('mustSee')">
        <ion-label>Luoghi da non perdere</ion-label>
        <div slot="end" class="item-preview">
          <ng-container *ngIf="tripMustSee.length > 0; else emptyMust">
            <div class="chip" *ngFor="let p of tripMustSee; let i = index">
              {{ p.name }}
              <button class="chip-remove" (click)="removePlaceFromMode('mustSee', i)">✕</button>
            </div>
          </ng-container>
          <ng-template #emptyMust>Nessun luogo inserito</ng-template>
        </div>
      </ion-item>

      <!-- eat -->
      <ion-item button (click)="openEditorInline('eat')">
        <ion-label>Posti dove vuoi mangiare</ion-label>
        <div slot="end" class="item-preview">
          <ng-container *ngIf="tripEatPlaces.length > 0; else emptyEat">
            <div class="chip" *ngFor="let p of tripEatPlaces; let i = index">
              {{ p.name }}
              <button class="chip-remove" (click)="removePlaceFromMode('eat', i)">✕</button>
            </div>
          </ng-container>
          <ng-template #emptyEat>Nessuno specificato</ng-template>
        </div>
      </ion-item>

      <!-- visited -->
      <ion-item button (click)="openEditorInline('visited')">
        <ion-label>Posti già visitati</ion-label>
        <div slot="end" class="item-preview">
          <ng-container *ngIf="tripAlreadyVisited.length > 0; else emptyVis">
            <div class="chip" *ngFor="let p of tripAlreadyVisited; let i = index">
              {{ p.name }}
              <button class="chip-remove" (click)="removePlaceFromMode('visited', i)">✕</button>
            </div>
          </ng-container>
          <ng-template #emptyVis>Nessuno</ng-template>
        </div>
      </ion-item>

    </div>

    <!-- SLIDE 1 – PREFERENZE -->
    <div class="slide-page prefs no-vert-scroll">
      <h2 class="slide-title">Personalizza il tuo viaggio</h2>

      <ion-item button (click)="openEditorInline('transport')">
        <ion-label>Mezzo preferito</ion-label>
        <div slot="end" class="item-preview">{{ tripTransport || 'Nessun mezzo selezionato' }}</div>
      </ion-item>

      <ion-item button (click)="openEditorInline('style')">
        <ion-label>Stile vacanza</ion-label>
        <div slot="end" class="item-preview">{{ trip?.style || 'Nessuno' }}</div>
      </ion-item>

      <ion-item button (click)="openEditorInline('ai')">
        <ion-label>Chiedi un consiglio all'AI</ion-label>
        <div slot="end" class="item-preview">{{ tripPrompt || 'Nessun consiglio' }}</div>
      </ion-item>
    </div>

  </div>

  <!-- MODALE EDITOR -->
  <div class="customization-sheet inline-editor" [class.visible]="editorVisible">
    <div class="sheet-header">
      <h2>
        {{ {
        mustSee: 'Luoghi da non perdere',
        eat: 'Posti dove mangiare',
        visited: 'Luoghi già visti',
        transport: 'Mezzo preferito',
        ai: 'Domanda per l’AI',
        style: 'Stile vacanza'
        }[editorMode!] }}
      </h2>
      <ion-button fill="clear" size="small" (click)="closeEditor()">Chiudi</ion-button>
    </div>

    <div class="sheet-content">

      <!-- mustSee -->
      <ng-container *ngIf="editorMode === 'mustSee'">
        <app-google-autocomplete placeholder="Aggiungi un luogo da non perdere…" [types]="['establishment']"
          [bounds]="tripBounds" [restrictToBounds]="true" (placeSelected)="onPlaceSelected('mustSee', $event)">
        </app-google-autocomplete>
        <ion-button expand="block" (click)="saveEditorValue()">Salva</ion-button>
        <div class="chip-container">
          <div class="chip" *ngFor="let p of tripMustSee; let i = index">
            {{ p.name }}
            <button class="chip-remove" (click)="removePlaceFromMode('mustSee', i)">✕</button>
          </div>
        </div>
      </ng-container>

      <!-- eat -->
      <ng-container *ngIf="editorMode === 'eat'">
        <app-google-autocomplete placeholder="Aggiungi un posto dove mangiare…" [types]="['restaurant']"
          [bounds]="tripBounds" [restrictToBounds]="true" (placeSelected)="onPlaceSelected('eat', $event)">
        </app-google-autocomplete>
        <ion-button expand="block" (click)="saveEditorValue()">Salva</ion-button>
        <div class="chip-container">
          <div class="chip" *ngFor="let p of tripEatPlaces; let i = index">
            {{ p.name }}
            <button class="chip-remove" (click)="removePlaceFromMode('eat', i)">✕</button>
          </div>
        </div>
      </ng-container>

      <!-- visited -->
      <ng-container *ngIf="editorMode === 'visited'">
        <app-google-autocomplete placeholder="Aggiungi un luogo già visitato…" [types]="['establishment']"
          [bounds]="tripBounds" [restrictToBounds]="true" (placeSelected)="onPlaceSelected('visited', $event)">
        </app-google-autocomplete>
        <ion-button expand="block" (click)="saveEditorValue()">Salva</ion-button>
        <div class="chip-container">
          <div class="chip" *ngFor="let p of tripAlreadyVisited; let i = index">
            {{ p.name }}
            <button class="chip-remove" (click)="removePlaceFromMode('visited', i)">✕</button>
          </div>
        </div>
      </ng-container>

      <!-- transport -->
      <ng-container *ngIf="editorMode === 'transport'">
        <ion-list>
          <ion-item button (click)="selectValue('walk')">🚶‍♂️ A piedi</ion-item>
          <ion-item button (click)="selectValue('car')">🚗 Auto</ion-item>
          <ion-item button (click)="selectValue('bus')">🚌 Bus</ion-item>
          <ion-item button (click)="selectValue('bike')">🚴‍♀️ Bicicletta</ion-item>
        </ion-list>
      </ng-container>

      <!-- style -->
      <ng-container *ngIf="editorMode === 'style'">
        <ion-list>
          <ion-item button (click)="selectValue('Standard')">🚶‍♂️ Standard</ion-item>
          <ion-item button (click)="selectValue('Giornata nei musei')">🚌 Giornata nei musei</ion-item>
          <ion-item button (click)="selectValue('Shopping')">🛍️ Shopping</ion-item>
          <ion-item button (click)="selectValue('Avventura')">🏞️ Avventura</ion-item>
          <ion-item button (click)="selectValue('Food Tour')">🍴 Food Tour</ion-item>
          <ion-item button (click)="selectValue('Relax')">🛀 Relax</ion-item>
        </ion-list>
      </ng-container>

      <!-- ai -->
      <ng-container *ngIf="editorMode === 'ai'">
        <ion-textarea autoGrow="true" placeholder="Scrivi qui…" [(ngModel)]="editorValue"
          (ngModelChange)="setValueForMode('ai', $event)">
        </ion-textarea>
        <ion-button expand="block" (click)="saveEditorValue()">Salva</ion-button>
      </ng-container>

    </div>
  </div>

  <!-- GENERA ITINERARIO -->
  <div class="generate-container fixed">
    <ion-button class="genera-itinerario-btn" (click)="generateItinerary()" *ngIf="!isLoading && isLocalTrip">
      Genera Itinerario
    </ion-button>
    <ion-button class="genera-itinerario-btn" disabled *ngIf="isLoading">
      Caricamento…
    </ion-button>
    <ion-button class="genera-itinerario-btn" disabled *ngIf="!isLoading && !isLocalTrip">
      Itinerario già generato
    </ion-button>
  </div>

</ion-content>

<!-- Overlay -->
<app-generation-overlay *ngIf="isLoading" [message]="'Generazione in corso…'"></app-generation-overlay>